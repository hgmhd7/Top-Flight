<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    body {
      margin: 0;
    }
  </style>

  <meta charset="UTF-8">
  <title>U.S. Demographics Correlations</title>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
    integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <script src="https:cdn.jsdelivr.net/npm/d3-dsv"></script>
  <script src="https:cdn.jsdelivr.net/npm/index-array-by"></script>

  <script src="https:cdn.jsdelivr.net/npm/globe.gl"></script>
  <!-- <script src="https://top/unpkg.com/globe.gl"></script> -->
  <!--<script src="../../dist/globe.gl.js"></script>-->
  <link rel="stylesheet" href="static/css/force_layout.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.5.0/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>

</head>

<body>

        <script type="text/javascript" src="static/js/build_navigator.js"></script>


    <div id="globeViz"></div>
    <div id="scatter"></div>

    <script>

const COUNTRY = 'United States';
    const OPACITY = 0.1;

        const myGlobe = Globe()


            (document.getElementById('globeViz'))
            .globeImageUrl('https:cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg')
            .pointOfView({ lat: 39.6, lng: -98.5, altitude: 2 }) // aim at continental US centroid



            .arcLabel(d => `${d.airline}: ${d.srcIata} &#8594; ${d.dstIata}`)
            .arcStartLat(d => +d.srcAirport.lat)
            .arcStartLng(d => +d.srcAirport.lng)
            .arcEndLat(d => +d.dstAirport.lat)
            .arcEndLng(d => +d.dstAirport.lng)
            .arcDashLength(0.25)
            .arcDashGap(1)
            .arcDashInitialGap(() => Math.random())
            .arcDashAnimateTime(4000)
            .arcColor(d => [`rgba(0, 255, 0, ${OPACITY})`, `rgba(255, 0, 0, ${OPACITY})`])
            .arcsTransitionDuration(0)


            .labelLat(d => +d.lat)
            .labelLng(d => +d.lng)
            .labelText(d => d.name)
            .labelSize(.10)
            .labelDotRadius(.10)
            .labelColor(() => 'rgba(255, 165, 0, 0.75)')
            .labelResolution(2);





        const airportParse = ([airportId, name, city, country, iata, icao, lat, lng, alt, timezone, dst, tz, type, source]) => ({ airportId, name, city, country, iata, icao, lat, lng, alt, timezone, dst, tz, type, source });
        const routeParse = ([airline, airlineId, srcIata, srcAirportId, dstIata, dstAirportId, codeshare, stops, equipment]) => ({ airline, airlineId, srcIata, srcAirportId, dstIata, dstAirportId, codeshare, stops, equipment });

        Promise.all([
            fetch('https://raw.githubusercontent.com/jpatokal/openflights/master/data/airports.dat').then(res => res.text())
                .then(d => d3.csvParseRows(d, airportParse)),
            fetch('https://raw.githubusercontent.com/jpatokal/openflights/master/data/routes.dat').then(res => res.text())
                .then(d => d3.csvParseRows(d, routeParse))
        ]).then(([airports, routes]) => {
            
            const byIata = indexBy(airports, 'iata', false);
            
            console.log(byIata)


            const filteredRoutes = routes
                .filter(d => byIata.hasOwnProperty(d.srcIata) && byIata.hasOwnProperty(d.dstIata)) // exclude unknown airports
                .filter(d => d.stops === '0') // non-stop flights only
                .map(d => Object.assign(d, {
                    srcAirport: byIata[d.srcIata],
                    dstAirport: byIata[d.dstIata]
                }))
                .filter(d => d.srcAirport.country === COUNTRY && d.dstAirport.country !== COUNTRY); // international routes from country
            
            console.log(routes)

            const filtered_airports = airports
            .filter(d => d.country === COUNTRY);

            console.log(airports)
            myGlobe
                .arcsData(filteredRoutes)
                .labelsData(filtered_airports);

        });



//     Globe()
//       .globeImageUrl('https:cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg')
//       .labelsData(places.name)
//       .labelLat(d => +d.lat)
//       .labelLng(d => +d.lng)
//       .labelText(d => d.name)
//       .labelSize(5)
//       .labelDotRadius(5)
//       .labelColor(() => 'rgba(255, 165, 0, 0.75)')
//       .labelResolution(2)
//     (document.getElementById('globeViz'))
//   });
    </script>


</body>